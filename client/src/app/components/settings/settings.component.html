<div class="settings-page">
    <div class="page-header">
        <h1 class="page-title">הגדרות</h1>
        <p class="page-subtitle">ניהול חיבורים, ערוצים וקבוצות</p>
    </div>

    <div class="settings-grid">
        <!-- Telegram Bot Token -->
        <section class="card section-card">
            <div class="section-header">
                <div class="section-icon tg"><i class='bx bxl-telegram'></i></div>
                <h3>Telegram Bot</h3>
            </div>
            <div class="section-body">
                <div class="form-field">
                    <label>Bot Token</label>
                    <input type="password" class="input" placeholder="123456:ABC-DEF..."
                        [ngModel]="form().telegramBotToken" (ngModelChange)="updateField('telegramBotToken', $event)" />
                </div>
                <button class="btn btn-ghost" (click)="restartBot()" [disabled]="settingsService.loading()">
                    <i class='bx bx-refresh'></i> {{ settingsService.loading() ? 'מפעיל מחדש...' : 'הפעל מחדש את הבוט'
                    }}
                </button>
            </div>
        </section>

        <!-- Telegram Channels -->
        <section class="card section-card">
            <div class="section-header">
                <div class="section-icon tg"><i class='bx bxs-megaphone'></i></div>
                <h3>ערוצי Telegram</h3>
                <button class="btn btn-primary btn-sm" (click)="addChannel()"><i class='bx bx-plus'></i> הוסף
                    ידנית</button>
                <button class="btn btn-ghost btn-sm" (click)="openChannelDiscovery()"><i class='bx bx-search'></i> מצא
                    ערוצים</button>
            </div>
            <div class="section-body">
                @if (channels().length === 0) {
                <div class="empty-list">
                    <p>לא הוספו ערוצים עדיין</p>
                    <div class="buttons-row">
                        <button class="btn btn-ghost" (click)="addChannel()"><i class='bx bx-plus'></i> הוסף
                            ידנית</button>
                        <button class="btn btn-ghost" (click)="openChannelDiscovery()"><i class='bx bx-search'></i> מצא
                            ערוצים פעילים</button>
                    </div>
                </div>
                }
                @for (ch of channels(); track $index; let i = $index) {
                <div class="list-item">
                    <div class="list-item-fields">
                        <input class="input input-sm" placeholder="שם הערוץ (לא חובה)" [ngModel]="ch.name"
                            (ngModelChange)="updateChannel(i, 'name', $event)" />
                        <input class="input input-sm input-mono" placeholder="-1001234567890" [ngModel]="ch.id"
                            (ngModelChange)="updateChannel(i, 'id', $event)" />
                    </div>
                    <button class="btn-icon btn-icon-danger" (click)="removeChannel(i)" title="הסר ערוץ"><i
                            class='bx bx-trash'></i></button>
                </div>
                }
            </div>
        </section>

        <!-- WhatsApp Groups -->
        <section class="card section-card">
            <div class="section-header">
                <div class="section-icon wa"><i class='bx bxl-whatsapp'></i></div>
                <h3>קבוצות WhatsApp</h3>
                <button class="btn btn-primary btn-sm" (click)="addGroup()"><i class='bx bx-plus'></i> הוסף
                    ידנית</button>
                <button class="btn btn-ghost btn-sm" (click)="openGroupDiscovery()"><i class='bx bx-search'></i> מצא
                    קבוצות</button>
            </div>
            <div class="section-body">
                @if (groups().length === 0) {
                <div class="empty-list">
                    <p>לא הוספו קבוצות עדיין</p>
                    <div class="buttons-row">
                        <button class="btn btn-ghost" (click)="addGroup()"><i class='bx bx-plus'></i> הוסף
                            ידנית</button>
                        <button class="btn btn-ghost" (click)="openGroupDiscovery()"><i class='bx bx-search'></i> מצא
                            קבוצות מהחשבון</button>
                    </div>
                </div>
                }
                @for (gr of groups(); track $index; let i = $index) {
                <div class="list-item">
                    <div class="list-item-fields">
                        <input class="input input-sm" placeholder="שם הקבוצה (לא חובה)" [ngModel]="gr.name"
                            (ngModelChange)="updateGroup(i, 'name', $event)" />
                        <input class="input input-sm input-mono" placeholder="120363xxx&#64;g.us" [ngModel]="gr.id"
                            (ngModelChange)="updateGroup(i, 'id', $event)" />
                    </div>
                    <button class="btn-icon btn-icon-danger" (click)="removeGroup(i)" title="הסר קבוצה"><i
                            class='bx bx-trash'></i></button>
                </div>
                }
            </div>

            <div class="section-footer">
                <button class="btn btn-danger btn-sm" (click)="hardReset()">
                    <i class='bx bx-trash-alt'></i> Hard Reset (התחברות מחדש)
                </button>
            </div>
        </section>

        <!-- Footer Editor -->
        <section class="card section-card">
            <div class="section-header">
                <div class="section-icon edit"><i class='bx bx-edit-alt'></i></div>
                <h3>טקסט תחתון (Footer)</h3>
            </div>
            <div class="section-body">
                <div class="toolbar">
                    <button class="btn-icon" (click)="insertMarkdown('bold')" title="Bold"><i
                            class='bx bx-bold'></i></button>
                    <button class="btn-icon" (click)="insertMarkdown('italic')" title="Italic"><i
                            class='bx bx-italic'></i></button>
                    <button class="btn-icon" (click)="insertMarkdown('strike')" title="Strikethrough"><i
                            class='bx bx-strikethrough'></i></button>
                </div>
                <textarea class="input" rows="3" placeholder="טקסט שיצורף לכל הודעה..." [ngModel]="form().footerText"
                    (ngModelChange)="updateField('footerText', $event)"></textarea>
                <p class="hint">השתמש ב: *bold* , _italic_ , ~strikethrough~</p>
            </div>
        </section>

        <!-- Queue Settings -->
        <section class="card section-card">
            <div class="section-header">
                <div class="section-icon queue"><i class='bx bx-list-ol'></i></div>
                <h3>תור הודעות</h3>
            </div>
            <div class="section-body">
                <label class="toggle-label">
                    <input type="checkbox" [ngModel]="form().autoRetry"
                        (ngModelChange)="updateField('autoRetry', $event)" />
                    ניסיון אוטומטי חוזר
                </label>
                <div class="form-field">
                    <label>מקסימום ניסיונות</label>
                    <input type="number" class="input input-sm input-short" [ngModel]="form().maxRetries"
                        (ngModelChange)="updateField('maxRetries', +$event)" />
                </div>
            </div>
        </section>
    </div>

    <!-- Save Bar -->
    <div class="save-bar">
        <button class="btn btn-primary btn-lg" (click)="save()" [disabled]="settingsService.loading()">
            {{ settingsService.loading() ? '' : '' }}
            <ng-container *ngIf="settingsService.loading(); else saveIcon">
                <i class='bx bx-loader-alt bx-spin'></i> שומר...
            </ng-container>
            <ng-template #saveIcon>
                <i class='bx bx-save'></i> שמור הגדרות
            </ng-template>
        </button>
    </div>

    @if (showSelection()) {
    <app-selection-dialog [title]="selectionTitle()" [items]="selectionItems()" [loading]="selectionLoading()"
        [emptyText]="selectionEmptyText()" (close)="showSelection.set(false)"
        (select)="onSelection($event)"></app-selection-dialog>
    }
</div>